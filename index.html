<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#ffffff" />
  <title>FURUYUME</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#fff;
      --text:#0a0a0a;
      --muted:#6b6b6b;
      --hair:#e9e9e9;
      --glass: rgba(255,255,255,.58);
      --glass2: rgba(255,255,255,.36);
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 18px;
      --ls: -0.05em;
      --ls-soft: -0.05em;

      --actions-space: 108px;
      --productbar-space: 64px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      letter-spacing: var(--ls);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
      overflow-x:hidden;
      touch-action: pan-y;
    }

    a{ color:inherit; text-decoration:none; }
    button{ font:inherit; letter-spacing: inherit; background:none; border:0; padding:0; color:inherit; }

    /* Safe areas for Telegram iOS */
    .safe{
      padding-left: max(16px, env(safe-area-inset-left));
      padding-right: max(16px, env(safe-area-inset-right));
    }
    .top-safe{ padding-top: calc(env(safe-area-inset-top) + 2px); }
    .bottom-safe{ padding-bottom: max(16px, env(safe-area-inset-bottom)); }

    /* Loading */
    .loader-screen{
      position:fixed; inset:0;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index:9999;
      transition: opacity .28s ease, transform .28s ease;
    }
    .loader-screen.hide{
      opacity:0;
      transform: scale(.99);
      pointer-events:none;
    }
    .spinner{
      width:44px; height:44px;
      border-radius:999px;
      border:3px solid #e8e8e8;
      border-top-color:#111;
      animation: spin .85s linear infinite;
      margin-bottom:14px;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }
    .loader-title{
      font-weight:600;
      font-size:14px;
      letter-spacing: var(--ls);
      text-transform: uppercase;
    }
    .loader-sub{
      margin-top:8px;
      max-width: 280px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
      letter-spacing: calc(var(--ls) + 0.02em);
      line-height: 1.35;
    }
    .loader-hint{
      margin-top:16px;
      font-size:12px;
      color: #8a8a8a;
      letter-spacing: calc(var(--ls) + 0.03em);
      opacity:0;
      transform: translateY(2px);
      transition: opacity .35s ease, transform .35s ease;
    }
    .loader-hint.show{ opacity:1; transform: translateY(0); }

    /* Layout */
    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
    }
    .header-space{ height: 0px; }

    /* MAIN HEADER */
    .topbar{
      position:relative;
      padding-top: 2px;
      padding-bottom: 6px;
    }

    .topbar-card{
      width: min(520px, 100%);
      margin: 0 auto;
      border-radius: 999px;
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      background-color: rgba(255,255,255,.72);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,.06);
      padding: 10px 14px;
    }

    .topbar-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      min-width:0;
    }

    .topbar-left{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      flex:0 0 auto;
    }

    .topbar-right{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 3px;
      min-width:0;
      flex:1 1 auto;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      white-space:nowrap;
      font-weight:400;
      font-size:12px;
      text-transform: uppercase;
      letter-spacing: var(--ls);
      mask-image: linear-gradient(to right, transparent 0%, black 15px);
      -webkit-mask-image: linear-gradient(to right, transparent 0%, black 15px);
      padding-left: 10px;
    }
    .topbar-right::-webkit-scrollbar{ display:none; }

    .nav-item{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 2px;
      border-radius: 12px;
      opacity: .92;
      transition: opacity .18s ease, transform .18s ease, background .18s ease;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      user-select:none;
      flex:0 0 auto;
      touch-action: manipulation;
    }
    .nav-item:active{ opacity: .70; transform: scale(.99); background: rgba(0,0,0,.04); }

    .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      width:44px; height:44px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      flex:0 0 auto;
    }
    .brand img{ width:100%; height:100%; object-fit:contain; display:block; }

    /* HERO */
    .hero{ padding-top: 10px; padding-bottom: 6px; }
    .hero-card{
      width: min(520px, 100%); margin: 0 auto; border-radius: 22px;
      overflow:hidden; border: 1px solid rgba(0,0,0,.06); background: rgba(0,0,0,.02);
    }
    .hero-card img{ width:100%; height:auto; display:block; object-fit:cover; }

    /* FLOATING GLASS HEADER */
    .floatbar{
      position:fixed; left:0; right:0; top: calc(env(safe-area-inset-top) + 2px);
      z-index: 2000; display:flex; justify-content:center; pointer-events:auto;
    }
    .floatbar-card{
      width: min(420px, calc(100% - 28px)); border-radius: 999px;
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      background-color: rgba(255,255,255,.72); backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px); box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,.06); padding: 8px 12px; opacity:0;
      transform: translateY(-10px); transition: opacity .22s ease, transform .22s ease;
      will-change: opacity, transform; contain: paint; pointer-events:auto;
    }
    .floatbar.show .floatbar-card{ opacity:1; transform: translateY(0); }
    .floatbar-inner{ display:flex; align-items:center; justify-content:space-between; gap: 10px; min-width:0; }
    .floatbar-left{ display:flex; align-items:center; justify-content:flex-start; flex:0 0 auto; }
    .floatbar-right{
      display:flex; align-items:center; justify-content:flex-end; gap: 3px; flex:1 1 auto;
      min-width:0; white-space:nowrap; overflow-x:auto; overflow-y:hidden;
      -webkit-overflow-scrolling: touch; scrollbar-width: none; font-weight:400;
      font-size:11px; text-transform: uppercase; letter-spacing: var(--ls);
      mask-image: linear-gradient(to right, transparent 0%, black 15px);
      -webkit-mask-image: linear-gradient(to right, transparent 0%, black 15px); padding-left: 10px;
    }
    .floatbar-right::-webkit-scrollbar{ display:none; }
    .floatbrand{
      width:40px; height:40px; display:flex; align-items:center; justify-content:center;
      -webkit-tap-highlight-color: transparent; cursor:pointer; user-select:none;
      flex:0 0 auto; border-radius: 12px; padding: 6px; touch-action: manipulation;
      transition: opacity .18s ease, transform .18s ease, background .18s ease;
    }
    .floatbrand:active{ opacity:.7; transform: scale(.99); background: rgba(0,0,0,.04); }
    .floatbrand img{ width:100%; height:100%; object-fit:contain; display:block; }

    /* SEARCH DRAWER */
    .drawer{ position: fixed; left: 0; right: 0; z-index: 3500; pointer-events: none; }
    .drawer.open{ pointer-events:auto; }
    .drawer-card{
      width: min(520px, calc(100% - 28px)); margin: 0 auto; border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,.68));
      background-color: rgba(255,255,255,.88); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 18px 50px rgba(0,0,0,.12); border: 1px solid rgba(0,0,0,.08); overflow:hidden;
      opacity:0; transform: translateY(-6px); transition: opacity .18s ease, transform .18s ease;
    }
    .drawer.open .drawer-card{ opacity:1; transform: translateY(0); }
    .drawer-top{ padding: 12px 14px; border-bottom: 1px solid rgba(0,0,0,.06); display:flex; align-items:center; gap: 10px; }
    .drawer-top input{
      width:100%; border: 0; outline: none; background: transparent;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text); letter-spacing: var(--ls); font-size: 12px; font-weight: 700; text-transform: uppercase;
    }
    .drawer-top input::placeholder{ color: rgba(10,10,10,.45); font-weight: 700; }
    .drawer-close{
      flex:0 0 auto; font-size:12px; font-weight:800; letter-spacing: var(--ls);
      text-transform: uppercase; opacity:.75; cursor:pointer; padding: 6px 8px;
      border-radius: 10px; transition: opacity .18s ease, transform .18s ease, background .18s ease;
      -webkit-tap-highlight-color: transparent; touch-action: manipulation;
    }
    .drawer-close:active{ opacity:.6; transform: scale(.98); background: rgba(0,0,0,.04); }
    .drawer-results{ padding: 10px 12px 12px; display:flex; flex-direction:column; gap: 10px; max-height: 44vh; overflow:auto; -webkit-overflow-scrolling: touch; }
    .result{
      display:flex; align-items:center; gap: 12px; padding: 10px 10px; border-radius: 14px;
      background: rgba(0,0,0,.03); border: 1px solid rgba(0,0,0,.05); cursor:pointer;
      -webkit-tap-highlight-color: transparent; transition: transform .18s ease, opacity .18s ease, background .18s ease; touch-action: manipulation;
    }
    .result:active{ transform: scale(.99); opacity:.85; background: rgba(0,0,0,.04); }
    .result-img{ width:44px; height:44px; display:flex; align-items:center; justify-content:center; flex:0 0 auto; overflow:hidden; }
    .result-img img{ width:100%; height:100%; object-fit:contain; display:block; pointer-events:none; user-select:none; }
    .result-mid{ min-width:0; flex:1 1 auto; }
    .result-name{ font-size:11px; font-weight:900; text-transform: uppercase; letter-spacing: var(--ls); line-height: 1.15; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .result-meta{ margin-top: 6px; font-size:10px; font-weight:800; text-transform: uppercase; letter-spacing: calc(var(--ls) + 0.02em); opacity:.72; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .result-price{ flex:0 0 auto; font-size:11px; font-weight:900; text-transform: uppercase; letter-spacing: calc(var(--ls) + 0.02em); opacity:.92; }
    .drawer-empty{ padding: 8px 2px 0; text-align:center; font-size:11px; font-weight:800; text-transform: uppercase; letter-spacing: calc(var(--ls) + 0.02em); opacity:.6; }

    /* CART MODAL */
    .modal{
      position:fixed; inset:0; z-index: 4000; display:none; align-items:flex-end; justify-content:center;
      background: rgba(0,0,0,.18); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      opacity:0; transition: opacity .18s ease;
    }
    .modal.show{ display:flex; }
    .modal.visible{ opacity:1; }
    .sheet{
      width: min(520px, 100%); margin: 0 auto; border-radius: 22px 22px 0 0;
      background: rgba(255,255,255,.92); border: 1px solid rgba(0,0,0,.08); box-shadow: 0 -18px 60px rgba(0,0,0,.18);
      padding: 14px 14px 18px; transform: translateY(14px); opacity:0; transition: transform .18s ease, opacity .18s ease;
    }
    .modal.visible .sheet{ transform: translateY(0); opacity:1; }
    .sheet-head{ display:flex; align-items:center; justify-content:space-between; gap: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,.06); }
    .sheet-title{ font-size:12px; font-weight:900; letter-spacing: var(--ls); text-transform: uppercase; }
    .sheet-close{
      font-size:12px; font-weight:900; letter-spacing: var(--ls); text-transform: uppercase;
      opacity:.7; padding: 8px 10px; border-radius: 12px; transition: opacity .18s ease, transform .18s ease, background .18s ease;
      -webkit-tap-highlight-color: transparent; cursor:pointer; touch-action: manipulation;
    }
    .sheet-close:active{ opacity:.55; transform: scale(.98); background: rgba(0,0,0,.04); }
    .sheet-body{ padding-top: 12px; }
    .cart-empty{ font-size:11px; font-weight:600; letter-spacing: calc(var(--ls) + 0.02em); text-transform: uppercase; opacity:.6; line-height: 1.35; padding: 12px 2px 1px; text-align:center; }
    .cart-list{ display:flex; flex-direction:column; gap: 10px; max-height: 46vh; overflow:auto; -webkit-overflow-scrolling: touch; padding-bottom: 12px; }
    .cart-row{ display:flex; align-items:center; gap: 12px; padding: 10px 10px; border-radius: 16px; background: rgba(0,0,0,.03); border: 1px solid rgba(0,0,0,.05); }
    .cart-img{ width:44px; height:44px; display:flex; align-items:center; justify-content:center; flex:0 0 auto; overflow:hidden; }
    .cart-img img{ width:100%; height:100%; object-fit:contain; display:block; pointer-events:none; user-select:none; }
    .cart-mid{ min-width:0; flex:1 1 auto; }
    .cart-name{ font-size:11px; font-weight:900; text-transform: uppercase; letter-spacing: var(--ls); line-height: 1.15; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .cart-meta{ margin-top: 6px; font-size:10px; font-weight:800; text-transform: uppercase; letter-spacing: calc(var(--ls) + 0.02em); opacity:.7; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .cart-qty{ display:flex; align-items:center; gap: 8px; flex:0 0 auto; }
    .qty-btn{ width:30px; height:30px; border-radius: 999px; background: rgba(255,255,255,.92); border: 1px solid rgba(0,0,0,.10); display:grid; place-items:center; font-weight:900; font-size:14px; cursor:pointer; -webkit-tap-highlight-color: transparent; transition: transform .18s ease, opacity .18s ease; user-select:none; touch-action: manipulation; }
    .qty-btn:active{ transform: scale(.98); opacity:.75; }
    .qty-val{ min-width: 20px; text-align:center; font-size:11px; font-weight:900; text-transform: uppercase; letter-spacing: var(--ls); opacity:.9; }
    .cart-sum{ margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,.06); display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .cart-total{ font-size:12px; font-weight:700; text-transform: uppercase; letter-spacing: var(--ls); }
    .cart-order{ padding: 12px 14px; border-radius: 14px; background: #111; color:#fff; font-size:12px; font-weight:900; text-transform: uppercase; letter-spacing: calc(var(--ls) + 0.02em); cursor:pointer; -webkit-tap-highlight-color: transparent; transition: transform .18s ease, opacity .18s ease; white-space:nowrap; touch-action: manipulation; }
    .cart-order:active{ transform: scale(.99); opacity:.85; }

    /* Categories */
    .categories{ padding-top: 10px; padding-bottom: 18px; }
    .cat-wrap{ display:flex; flex-wrap:wrap; justify-content:center; gap: 10px 18px; padding-top: 6px; }
    .cat{ font-weight:600; font-size:10px; text-transform: uppercase; opacity:.9; cursor:pointer; padding: 7px 12px; border-radius: 10px; transition: opacity .18s ease, transform .18s ease, background .18s ease; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .cat:active{ transform: scale(.98); opacity:.7; }
    .cat.active{ opacity: 1; background: rgba(0,0,0,.04); }

    /* Products grid */
    .content{ flex:1; padding-bottom: 22px; }
    .products{ width: min(520px, 100%); margin: 0 auto; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 30px 18px; align-items:start; padding-top: 4px; transition: opacity .18s ease, transform .18s ease; }
    .grid.fade-out{ opacity:0; transform: translateY(4px); }
    .card{ text-align:center; user-select:none; }
    .img{ width:100%; aspect-ratio: 1/1; display:flex; align-items:center; justify-content:center; overflow:hidden; background: transparent; border-radius: 18px; cursor:pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .product-photo{ width: 100%; height: 100%; object-fit: contain; display:block; -webkit-user-drag: none; user-select:none; pointer-events:none; }
    .name{ margin-top: 14px; font-weight:650; font-size:14px; text-transform: uppercase; letter-spacing: var(--ls); line-height: 1.1; min-height: calc(2 * 1.1em); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; cursor:pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .desc{ margin-top: 6px; font-weight:600; font-size:12px; text-transform: uppercase; color:#111; opacity:.85; letter-spacing: calc(var(--ls) + 0.02em); }
    .price-row{ margin-top: 10px; display:flex; align-items:baseline; justify-content:center; gap: 8px; font-size:14px; font-weight:800; letter-spacing: calc(var(--ls) + 0.02em); text-transform: uppercase; }
    .old{ font-weight:700; color: #8b8b8b; text-decoration: line-through; font-size: 12px; letter-spacing: calc(var(--ls) + 0.03em); }
    .dolyami{ margin-top: 10px; display:inline-flex; align-items:center; gap: 10px; padding: 10px 12px; border-radius: 999px; background: rgba(0,0,0,.06); color:#111; font-weight:500; font-size:12px; letter-spacing: var(--ls-soft); text-transform: none; }
    .dolyami-icon{ width:18px; height:18px; display:block; object-fit:contain; flex:0 0 auto; }

    /* Footer */
    .footer{ padding-top: 26px; padding-bottom: 34px; }
    .footer-links, .footer-legal{ display:flex; justify-content:center; flex-wrap:wrap; gap: 12px 18px; font-weight:600; font-size:9px; text-transform: uppercase; letter-spacing: calc(var(--ls) + 0.03em); line-height: 1.2; }
    .footer-links{ opacity: .92; margin-bottom: 12px; }
    .footer-legal{ opacity: .85; margin-top: 0; }
    .footer-copy{ margin-top: 12px; text-align:center; font-weight:600; font-size:9px; text-transform: uppercase; letter-spacing: calc(var(--ls) + 0.03em); opacity: .85; line-height: 1.2; }
    .footer a{ transition: opacity .18s ease, transform .18s ease; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .footer a:active{ opacity:.65; transform: scale(.99); }

    /* PRODUCT VIEW */
    .product-view{ position:fixed; inset:0; z-index: 3000; background: var(--bg); display:none; overflow:hidden; }
    .product-view.show{ display:block; }
    .product-scroll{
      position:absolute; inset:0; overflow:auto; -webkit-overflow-scrolling: touch;
      padding-top: calc(env(safe-area-inset-top) + 6px);
      padding-bottom: calc(85px + env(safe-area-inset-bottom));
      display:flex; flex-direction:column; min-height: 100vh;
    }

    /* Плавный переход внутри карточки товара (opacity) */
    .pwrap { transition: opacity 0.25s ease; width: min(520px, 100%); margin: 0 auto; padding-top: 6px; display:flex; flex-direction:column; flex: 1 0 auto; min-height: 0; }
    .pwrap.fade-out { opacity: 0; }

    /* ✅ ФИКС 2: Простая кнопка НАЗАД без подложки */
    .productbar { position: relative; z-index: 3100; padding: 12px 14px 6px; pointer-events: none; display: flex; align-items: center; }
    .backbtn {
      pointer-events: auto; width: 44px; height: 44px; display: grid; place-items: center;
      cursor: pointer; -webkit-tap-highlight-color: transparent; transition: transform .18s ease, opacity .18s ease;
      background: transparent; border: 0; touch-action: manipulation; margin-left: -8px;
    }
    .backbtn:active { transform: scale(.92); opacity: .6; }
    .backbtn svg { width: 22px; height: 22px; display: block; }

    /* ✅ НОВАЯ ГАЛЕРЕЯ (Скролл + точки поверх + 1080x1350) */
    .gallery{ position:relative; border-radius: 22px; overflow:hidden; border: 1px solid rgba(0,0,0,.06); background: rgba(0,0,0,.02); flex: 0 0 auto; }
    .gallery-stage{
      width: 100%; 
      aspect-ratio: 1080 / 1350; /* Пропорция 4:5 */
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
      touch-action: pan-x pan-y;
      position:relative;
    }
    .gallery-stage::-webkit-scrollbar { display: none; }
    
    .gallery-stage img{
      flex: 0 0 100%;
      width: 100%; height: 100%;
      object-fit: contain; /* картинка аккуратно вписывается */
      scroll-snap-align: center;
      cursor: zoom-in;
      display:block; user-select:none; pointer-events:auto;
    }

    /* ✅ ФИКС 3: Точки-индикаторы теперь ПОВЕРХ фото, в самом низу */
    .gallery-dots {
      position: absolute; bottom: 12px; left: 0; right: 0;
      display: flex; justify-content: center; gap: 6px; pointer-events: none; z-index: 10;
    }
    .dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: rgba(0,0,0,.2);
      transition: background .25s ease, transform .25s ease;
    }
    .dot.active { background: rgba(0,0,0,.8); transform: scale(1.2); }

    .pinfo{ padding: 10px 4px 0; text-align:center; }
    .ptitle{ font-size:16px; font-weight:700; text-transform: uppercase; letter-spacing: var(--ls); line-height: 1.15; }
    .psku{ margin-top: 10px; font-size:11px; font-weight:600; text-transform: uppercase; letter-spacing: calc(var(--ls) + 0.02em); opacity:.65; }
    .pprice{ margin-top: 14px; display:flex; align-items:baseline; justify-content:center; gap: 10px; font-size:16px; font-weight:700; text-transform: uppercase; letter-spacing: calc(var(--ls) + 0.02em); }
    .pprice .pold{ font-size:13px; font-weight:600; color:#8b8b8b; text-decoration: line-through; letter-spacing: calc(var(--ls) + 0.03em); }

    .psizes-wrap{ margin-top: 14px; display:flex; justify-content:center; align-items:center; gap: 10px; flex-wrap:wrap; }
    .psizes{ display:flex; justify-content:center; align-items:center; gap: 10px; flex-wrap:wrap; margin-top: 0; }
    .sizebtn{
      min-width: 46px; height: 40px; padding: 0 12px; display: inline-flex; align-items: center; justify-content: center;
      border-radius: 14px; border: 1px solid rgba(0,0,0,.10); background: rgba(0,0,0,.02); font-size:12px; font-weight:700;
      text-transform: uppercase; letter-spacing: var(--ls); cursor:pointer; -webkit-tap-highlight-color: transparent;
      transition: transform .18s ease, opacity .18s ease, background .18s ease; user-select:none; touch-action: manipulation;
    }
    .sizebtn:active{ transform: scale(.99); opacity:.85; }
    .sizebtn.active{ background: rgba(0,0,0,.08); border-color: rgba(0,0,0,.16); }
    .sizechart-icon-btn { padding: 0; width: 46px; opacity: .92; }
    .sizechart-icon-btn svg { width: 18px; height: 18px; display: block; }
    .sizechart-icon-btn:active{ background: rgba(0,0,0,.04); }

    .pdesc{ margin-top: 18px; text-align:left; padding: 0 6px; font-size:10px; font-weight:700; letter-spacing: calc(var(--ls) + 0.02em); line-height: 1.55; opacity:.86; text-transform:none; }
    .pdesc h3{ margin: 0 0 2px; font-size:12px; font-weight:900; text-transform: uppercase; letter-spacing: var(--ls); opacity:.92; }
    .pdesc ul{ margin:0; padding-left: 0; list-style: none; }
    .pdesc li{ margin: 4px 0; }

    .related{ margin-top: 22px; padding: 0 6px; margin-bottom: 18px; }
    .related-head{ display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-bottom: 10px; }
    .related-title{ font-size:12px; font-weight:900; text-transform: uppercase; letter-spacing: var(--ls); opacity:.92; }
    
    /* ✅ ФИКС 1: Свободный инерционный скролл без грубого примагничивания */
    .rel-track{ display:flex; gap: 12px; overflow:auto; -webkit-overflow-scrolling: touch; padding: 2px 2px 8px; scrollbar-width: none; -ms-overflow-style: none; }
    .rel-track::-webkit-scrollbar{ display:none; }
    .rel-card{ flex: 0 0 140px; border-radius: 18px; border: 1px solid rgba(0,0,0,.06); background: rgba(0,0,0,.02); padding: 12px 10px; cursor:pointer; -webkit-tap-highlight-color: transparent; transition: transform .18s ease, opacity .18s ease; touch-action: manipulation; }
    .rel-card:active{ transform: scale(.99); opacity:.85; }
    
    .rel-img{ width:100%; aspect-ratio: 1/1; display:flex; align-items:center; justify-content:center; overflow:hidden; background: transparent; margin-bottom: 10px; }
    .rel-img img{ width:100%; height:100%; object-fit: contain; display:block; pointer-events:none; user-select:none; }
    .rel-name{ font-size:10px; font-weight:900; text-transform: uppercase; letter-spacing: var(--ls); line-height: 1.15; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow:hidden; opacity:.92; min-height: calc(2 * 1.15em); }
    .rel-price{ margin-top: 8px; font-size:10px; font-weight:900; text-transform: uppercase; letter-spacing: calc(var(--ls) + 0.02em); opacity:.78; }

    .rel-scrollbar{ margin-top: 10px; height: 6px; border-radius: 999px; background: rgba(0,0,0,.08); border: 1px solid rgba(0,0,0,.06); position: relative; overflow:hidden; user-select:none; touch-action: none; }
    .rel-thumb{ position:absolute; top:0; left:0; height:100%; border-radius: 999px; background: rgba(0,0,0,.55); box-shadow: 0 10px 22px rgba(0,0,0,.10); width: 40px; transform: translateX(0); transition: opacity .18s ease; opacity:.9; }
    .rel-scrollbar.dragging .rel-thumb{ opacity: 1; }

    .product-actions{
      position:fixed; left:0; right:0; bottom:0; z-index: 12;
      background: linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,.92) 32%, rgba(255,255,255,.92));
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,.06);
      padding-top: 10px; padding-bottom: calc(16px + env(safe-area-inset-bottom));
    }
    .actions-inner{ width: min(520px, 100%); margin: 0 auto; display:flex; gap: 10px; align-items:center; justify-content:space-between; }
    .act-btn{ flex:1 1 50%; padding: 14px 14px; border-radius: 16px; font-size:12px; font-weight:700; text-transform: uppercase; letter-spacing: calc(var(--ls) + 0.02em); cursor:pointer; -webkit-tap-highlight-color: transparent; transition: transform .18s ease, opacity .18s ease; user-select:none; white-space:nowrap; touch-action: manipulation; }
    .act-btn:active{ transform: scale(.99); opacity:.85; }
    .btn-primary{ background:#111; color:#fff; }
    .btn-ghost{ background: rgba(0,0,0,.06); color:#111; border: 1px solid rgba(0,0,0,.08); }

    body.product-open .floatbar{ display:none; }
    body.product-open .app{ display:none; }
    .product-view .footer{ margin-top: auto; padding-top: 18px; padding-bottom: 18px; }

    /* ПРОСТОЙ И УНИВЕРСАЛЬНЫЙ ПРОСМОТРЩИК ФОТО */
    .image-viewer {
      position: fixed; inset: 0; z-index: 5000;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,.85); /* Затемнение */
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      opacity: 0; transition: opacity .25s ease;
      padding: env(safe-area-inset-top) max(16px, env(safe-area-inset-right)) env(safe-area-inset-bottom) max(16px, env(safe-area-inset-left));
      cursor: pointer; /* Подсказывает, что можно закрыть кликом */
    }
    .image-viewer.show { display: flex; }
    .image-viewer.visible { opacity: 1; }
    .image-viewer img {
      max-width: 98%; max-height: 98%;
      object-fit: contain;
      border-radius: 12px; /* Чуть скруглим углы для стиля */
      user-select: none; pointer-events: none; /* Чтобы клик пробивал на фон */
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    @media (max-width: 360px){
      .topbar-card{ padding: 9px 12px; }
      .brand{ width:40px; height:40px; }
      .topbar-right{ gap: 2px; font-size: 10.5px; }
      .floatbrand{ width:36px; height:36px; }
      .floatbar-right{ gap: 2px; font-size: 10.5px; }
      .cat{ font-size: 10px; }
      .grid{ gap: 26px 14px; }
      .name{ font-size: 13px; min-height: calc(2 * 1.1em); }
      :root{ --productbar-space: 60px; }
    }
  </style>
</head>

<body>
  <div id="loader" class="loader-screen safe top-safe bottom-safe" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loader-title">Загрузка</div>
    <div class="loader-sub">Прогружаем всё нужное. Если загрузка идёт слишком долго - перезагрузите приложение.</div>
    <div id="loaderHint" class="loader-hint">Совет: иногда помогает закрыть и открыть Telegram заново.</div>
  </div>

  <div id="searchDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-card" role="dialog" aria-label="Поиск товаров">
      <div class="drawer-top">
        <input id="searchInput" type="text" inputmode="search" autocomplete="off" placeholder="ВВЕДИТЕ НАЗВАНИЕ ТОВАРА" aria-label="Поиск товаров">
        <button id="searchClose" class="drawer-close" type="button" aria-label="Закрыть поиск">закрыть</button>
      </div>
      <div id="searchResults" class="drawer-results" aria-live="polite">
        <div class="drawer-empty">начните ввод - появятся товары</div>
      </div>
    </div>
  </div>

  <div id="cartModal" class="modal" aria-hidden="true">
    <div class="sheet safe bottom-safe" role="dialog" aria-label="Корзина">
      <div class="sheet-head">
        <div class="sheet-title">корзина</div>
        <button id="cartClose" class="sheet-close" type="button">закрыть</button>
      </div>
      <div class="sheet-body">
        <div id="cartEmpty" class="cart-empty" style="display:none;">корзина пустая</div>
        <div id="cartList" class="cart-list"></div>
        <div class="cart-sum">
          <div id="cartTotal" class="cart-total">итого: 0 rub</div>
          <button id="cartOrderBtn" class="cart-order" type="button">заказать сейчас</button>
        </div>
      </div>
    </div>
  </div>

  <div id="floatbar" class="floatbar safe" aria-hidden="true">
    <div class="floatbar-card">
      <div class="floatbar-inner">
        <div class="floatbar-left">
          <button class="floatbrand" id="floatLogoBtn" type="button" aria-label="FURUYUME — наверх">
            <img src="logo.png" alt="FURUYUME">
          </button>
        </div>
        <div class="floatbar-right">
          <button class="nav-item" type="button" data-action="search" aria-label="ПОИСК">ПОИСК</button>
          <a class="nav-item" href="https://t.me/furuyumemngrs" target="_blank" rel="noopener" aria-label="Поддержка">поддержка</a>
          <a class="nav-item" href="https://t.me/furuyumedelivery/9" target="_blank" rel="noopener" aria-label="Отзывы">отзывы</a>
          <button class="nav-item" type="button" data-action="cart" aria-label="КОРЗИНА">КОРЗИНА</button>
        </div>
      </div>
    </div>
  </div>

  <div id="imageViewer" class="image-viewer" aria-hidden="true" title="Нажмите, чтобы закрыть">
    <img id="viewerImg" src="" alt="Full image">
  </div>

  <section id="productView" class="product-view" aria-hidden="true">
    <div id="productScroll" class="product-scroll safe">
      
      <header class="productbar" aria-label="Навигация товара">
        <button id="productBack" class="backbtn" type="button" aria-label="Назад">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M15 6L9 12l6 6" stroke="#8b8b8b" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </header>

      <div class="pwrap" id="pwrap">
        <section class="gallery" aria-label="Фото товара">
          <div id="galleryStage" class="gallery-stage" aria-label="Свайпайте фото"></div>
          <div id="galleryDots" class="gallery-dots" aria-hidden="true"></div>
        </section>

        <section class="pinfo" aria-label="Информация о товаре">
          <div id="pTitle" class="ptitle"></div>
          <div id="pSku" class="psku"></div>
          <div class="pprice" aria-label="Цена">
            <span id="pPrice"></span>
            <span id="pOld" class="pold"></span>
          </div>

          <div class="psizes-wrap">
            <div id="pSizes" class="psizes" aria-label="Размеры"></div>
            <button id="sizeChartBtn" class="sizebtn sizechart-icon-btn" type="button" aria-label="Размерная сетка">
              <svg viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
              </svg>
            </button>
          </div>

          <div class="pdesc" aria-label="Описание">
            <h3>Описание</h3>
            <ul id="pDescList"></ul>
          </div>
        </section>

        <section class="related" aria-label="Смотрите также">
          <div class="related-head">
            <div class="related-title">Смотрите также</div>
          </div>
          <div id="relTrack" class="rel-track"></div>
          <div id="relScrollbar" class="rel-scrollbar" aria-hidden="true">
            <div id="relThumb" class="rel-thumb"></div>
          </div>
        </section>

        <footer class="footer bottom-safe" aria-label="Нижнее меню">
          <div class="footer-links">
            <a href="https://t.me/furuyume" target="_blank" rel="noopener">telegram</a>
            <a href="https://www.tiktok.com/@furuyume" target="_blank" rel="noopener">tiktok</a>
            <a href="https://www.instagram.com/furuyume.store/" target="_blank" rel="noopener">instagram</a>
            <a href="https://furuyume.online" target="_blank" rel="noopener">site</a>
          </div>
          <div class="footer-legal">
            <a href="https://t.me/furuyumedelivery/7" target="_blank" rel="noopener">политика конфиденциальности</a>
            <a href="https://t.me/furuyumedelivery/7" target="_blank" rel="noopener">договор оферты</a>
          </div>
          <div class="footer-copy">FURUYUME © 2026</div>
        </footer>
      </div>
    </div>

    <div class="product-actions safe" aria-label="Действия">
      <div class="actions-inner">
        <button id="buyNowBtn" class="act-btn btn-primary" type="button">заказать сейчас</button>
        <button id="addToCartBtn" class="act-btn btn-ghost" type="button">добавить в корзину</button>
      </div>
    </div>
  </section>

  <div class="app">
    <div class="header-space" aria-hidden="true"></div>
    <header id="mainHeader" class="topbar safe top-safe">
      <div class="topbar-card">
        <div class="topbar-inner">
          <div class="topbar-left">
            <button class="brand" id="logoBtn" type="button" aria-label="FURUYUME — наверх">
              <img src="logo.png" alt="FURUYUME">
            </button>
          </div>
          <nav class="topbar-right" aria-label="Меню">
            <button class="nav-item" type="button" data-action="search" aria-label="ПОИСК">ПОИСК</button>
            <a class="nav-item" href="https://t.me/furuyumemngrs" target="_blank" rel="noopener" aria-label="Поддержка">поддержка</a>
            <a class="nav-item" href="https://t.me/furuyumedelivery/9" target="_blank" rel="noopener" aria-label="Отзывы">отзывы</a>
            <button class="nav-item" type="button" data-action="cart" aria-label="КОРЗИНА">КОРЗИНА</button>
          </nav>
        </div>
      </div>
    </header>

    <section class="hero safe" aria-label="Фото">
      <div class="hero-card">
        <img src="hero.png" alt="FURUYUME">
      </div>
    </section>

    <section class="categories safe" aria-label="Категории">
      <div class="cat-wrap" id="catWrap"></div>
    </section>

    <main class="content safe" aria-label="Товары">
      <section class="products">
        <div id="grid" class="grid" aria-live="polite"></div>
      </section>
    </main>

    <footer class="footer safe bottom-safe">
      <div class="footer-links">
        <a href="https://t.me/furuyume" target="_blank" rel="noopener">telegram</a>
        <a href="https://www.tiktok.com/@furuyume" target="_blank" rel="noopener">tiktok</a>
        <a href="https://www.instagram.com/furuyume.store/" target="_blank" rel="noopener">instagram</a>
        <a href="https://furuyume.online" target="_blank" rel="noopener">site</a>
      </div>
      <div class="footer-legal">
        <a href="https://t.me/furuyumedelivery/7" target="_blank" rel="noopener">политика конфиденциальности</a>
        <a href="https://t.me/furuyumedelivery/7" target="_blank" rel="noopener">договор оферты</a>
      </div>
      <div class="footer-copy">FURUYUME © 2026</div>
    </footer>
  </div>

  <script>
    const CATEGORIES = [
      { id: "all", label: "Все" },
      { id: "olymp", label: "Олимпийки" },
      { id: "bombers", label: "Бомберы" },
      { id: "hoodies", label: "Худи" },
      { id: "longsleeves", label: "Лонгсливы" },
      { id: "tees", label: "Футболки" },
      { id: "pants", label: "Штаны" },
      { id: "shoes", label: "Обувь" }
    ];

    const PRODUCTS = [
      {
        id:"p1",
        slug:"adidas-yohjiyamamoto-wt",
        name:"ADIDAS X YOHJI YAMAMOTO TRACK JACKET (WHITE-TURQ)",
        badge:"РАСПРОДАЖА",
        priceRub: 4200,
        oldPriceRub: 7200,
        dolyami:"Долями по 1 050 ₽",
        categories:["olymp"],
        gallery: ["p1_1.png","p1_2.png","p1_3.png","p1_4.png"],
        articles: { S:"AYYWT-S", M:"AYYWT-M", L:"AYYWT-L", XL:"AYYWT-XL" },
        desc: [
          "РАСПРОДАЖА - Максимальная скидка. БЕЗ РЕСТОКА!",
          "Ткань: 3ех нитка футер диагональ (90% хлопок и 10% п/э).",
          "Все делали выполнены качественной вышивкой.",
          "Стирать в холодной воде, деликатный режим."
        ]
      },
      {
        id:"p2",
        slug:"adidas-yohjiyamamoto-wb",
        name:"ADIDAS X YOHJI YAMAMOTO TRACK JACKET (WHITE-BLACK)",
        badge:"РАСПРОДАЖА",
        priceRub: 4200,
        oldPriceRub: 7200,
        dolyami:"Долями по 1 050 ₽",
        categories:["olymp"],
        gallery: ["p2_1.png","p2_2.png","p2_3.png","p2_4.png"],
        articles: { S:"AYYWB-S", M:"AYYWB-M", L:"AYYWB-L", XL:"AYYWB-XL" },
        desc: [
          "РАСПРОДАЖА - Максимальная скидка. БЕЗ РЕСТОКА!",
          "Ткань: 3ех нитка футер диагональ (90% хлопок и 10% п/э).",
          "Все делали выполнены качественной вышивкой.",
          "Стирать в холодной воде, деликатный режим."
        ]
      },
      {
        id:"p3",
        slug:"adidas-japan",
        name:"ADIDAS JAPAN TRACK JACKET",
        badge:"РАСПРОДАЖА",
        priceRub: 3000,
        oldPriceRub: 7600,
        dolyami:"Долями по 1 000 ₽",
        categories:["olymp"],
        gallery: ["p3_1.png","p3_2.png","p3_3.png","p3_4.png"],
        articles: { S:"AJ-S", M:"AJ-M", L:"AJ-L", XL:"AJ-XL" },
        desc: [
          "РАСПРОДАЖА - Максимальная скидка. БЕЗ РЕСТОКА!",
          "Ткань: 3ех нитка футер диагональ (90% хлопок и 10% п/э).",
          "Все делали выполнены качественной вышивкой.",
          "Стирать в холодной воде, деликатный режим."
        ]
      },
      {
        id:"p4",
        slug:"adidas-chinese",
        name:"ADIDAS CHINESE TRACK JACKET",
        badge:"ОРИГИНАЛ",
        priceRub: 5700,
        oldPriceRub: 10900,
        dolyami:"Долями недоступно",
        categories:["olymp"],
        gallery: ["p4_1.png","p4_2.png","p4_3.png","p4_4.png"],
        articles: { S:"AC-S", M:"AC-M", L:"AC-L", XL:"AC-XL" },
        desc: [
          "ОРИГИНАЛ под заказ с Poizon (Шанхай).",
          "Оверсайз крой, легкая посадка - идеально для весны.",
          "Все детали выполнены качественной вышивкой.",
          "Стирать в холодной воде, деликатный режим."
        ]
      },
      {
        id:"p5",
        slug:"vtmaibomber",
        name:"VETEMENTS X ALPHA INDUSTRIES AW18 BOMBER",
        badge:"ПРЕДЗАКАЗ",
        priceRub: 12800,
        oldPriceRub: 31000,
        dolyami:"Долями недоступно",
        categories:["bombers"],
        gallery: ["p5_1.png","p5_2.png","p5_3.png","p5_4.png"],
        articles: { S:"AW18-S", M:"AW18-M", L:"AW18-L", XL:"AW18-XL" },
        desc: [
          "ЛУЧШАЯ РЕПЛИКА на рынке, оформляется под заказ.",
          "Оверсайз крой, легкая посадка - идеально для весны и лета.",
          "Все детали выполнены качественной вышивкой.",
          "Полная копия: сертификат FAKEBUSTERS, бирки и нашивки."
        ]
      },
      {
        id:"p6",
        slug:"vtmaiblbomber",
        name:"VETEMENTS X ALPHA INDUSTRIES BLACKOUT BOMBER",
        badge:"ПРЕДЗАКАЗ",
        priceRub: 8900,
        oldPriceRub: 17800,
        dolyami:"Долями недоступно",
        categories:["bombers"],
        gallery: ["p6_1.png","p6_2.png","p6_3.png","p6_4.png"],
        articles: { S:"BLOUT-S", M:"BLOUT-M", L:"BLOUT-L", XL:"BLOUT-XL" },
        desc: [
          "ЛУЧШАЯ РЕПЛИКА на рынке, оформляется под заказ.",
          "Оверсайз крой, легкая посадка - идеально для весны и лета.",
          "Все детали выполнены качественной вышивкой.",
          "Полная копия: сертификат FAKEBUSTERS, бирки и нашивки."
        ]
      },
      {
        id:"p7",
        slug:"furhoodiew",
        name:"FURUYUME PLUSH HOODIE (WHITE)",
        badge:"РАСПРОДАЖА",
        priceRub: 3000,
        oldPriceRub: 5700,
        dolyami:"Долями по 1 000 ₽",
        categories:["hoodies"],
        gallery: ["p7_1.png","p7_2.png","p7_3.png","p7_4.png"],
        articles: { S:"FHW-S", M:"FHW-M", L:"FHW-L", XL:"FHW-XL" },
        desc: [
          "НАШЕ ЛЕГЕНДАРНОЕ ПЛЮШЕВОЕ ХУДИ - с него началась история.",
          "Ткань: японский плюш. Оверсайз крой, теплый и приятный материал.",
          "Все детали выполнены качественной вышивкой.",
          "Стирать в холодной воде, деликатный режим."
        ]
      },
      {
        id:"p8",
        slug:"furhoodieb",
        name:"FURUYUME PLUSH HOODIE (BLACK)",
        badge:"РАСПРОДАЖА",
        priceRub: 3000,
        oldPriceRub: 5700,
        dolyami:"Долями по 1 000 ₽",
        categories:["hoodies"],
        gallery: ["p8_1.png","p8_2.png","p8_3.png","p8_4.png"],
        articles: { S:"FHB-S", M:"FHB-M", L:"FHB-L", XL:"FHB-XL" },
        desc: [
          "НАШЕ ЛЕГЕНДАРНОЕ ПЛЮШЕВОЕ ХУДИ - с него началась история.",
          "Ткань: японский плюш. Оверсайз крой, теплый и приятный материал.",
          "Все детали выполнены качественной вышивкой.",
          "Стирать в холодной воде, деликатный режим."
        ]
      },
      {
        id:"p9",
        slug:"anshirt",
        name:"ADIDAS X NIGO SHIRT JAPAN",
        badge:"ПРЕДЗАКАЗ",
        priceRub: 3200,
        oldPriceRub: 4000,
        dolyami:"Долями недоступно",
        categories:["tees"],
        gallery: ["p9_1.png","p9_2.png","p9_3.png","p9_4.png"],
        articles: { S:"ANS-S", M:"ANS-M", L:"ANS-L", XL:"ANS-XL" },
        desc: [
          "ЛУЧШАЯ РЕПЛИКА на рынке, оформляется под заказ.",
          "Оверсайз крой, легкая посадка - идеально для весны и лета.",
          "Все детали выполнены качественной вышивкой.",
          "Стирать в холодной воде, деликатный режим."
        ]
      },
      {
        id:"p10",
        slug:"asgshirt",
        name:"ADIDAS SUMMER GLOW JERSEY WONDER",
        badge:"ОРИГИНАЛ",
        priceRub: 9100,
        oldPriceRub: 17400,
        dolyami:"Долями недоступно",
        categories:["tees"],
        gallery: ["p10_1.png","p10_2.png","p10_3.png","p10_4.png"],
        articles: { S:"ASG-S", M:"ASG-M", L:"ASG-L", XL:"ASG-XL" },
        desc: [
          "ОРИГИНАЛ под заказ с Poizon (Шанхай).",
          "Оверсайз крой, легкая посадка - идеально для весны и лета.",
          "Все детали выполнены качественной вышивкой.",
          "Стирать в холодной воде, деликатный режим."
        ]
      },
      {
        id:"p11",
        slug:"aamshirt",
        name:"ADIDAS SHIRT AC MILAN",
        badge:"ПРЕДЗАКАЗ",
        priceRub: 4200,
        oldPriceRub: 5700,
        dolyami:"Долями недоступно",
        categories:["tees"],
        gallery: ["p11_1.png","p11_2.png","p11_3.png","p11_4.png"],
        articles: { S:"AAM-S", M:"AAM-M", L:"AAM-L", XL:"AAM-XL" },
        desc: [
          "ЛУЧШАЯ РЕПЛИКА на рынке, оформляется под заказ.",
          "Оверсайз крой, легкая посадка - идеально для весны и лета.",
          "Все детали выполнены качественной вышивкой.",
          "Стирать в холодной воде, деликатный режим."
        ]
      },
      {
        id:"p12",
        slug:"nasshirt",
        name:"NIKE ARSENAL FC SEGA SHIRT",
        badge:"ПРЕДЗАКАЗ",
        priceRub: 4200,
        oldPriceRub: 5700,
        dolyami:"Долями недоступно",
        categories:["tees"],
        gallery: ["p12_1.png","p12_2.png","p12_3.png","p12_4.png"],
        articles: { S:"NAS-S", M:"NAS-M", L:"NAS-L", XL:"NAS-XL" },
        desc: [
          "ЛУЧШАЯ РЕПЛИКА на рынке, оформляется под заказ.",
          "Оверсайз крой, легкая посадка - идеально для весны и лета.",
          "Все детали выполнены качественной вышивкой.",
          "Стирать в холодной воде, деликатный режим."
        ]
      }
    ];

    const loader = document.getElementById("loader");
    const loaderHint = document.getElementById("loaderHint");
    const mainHeader = document.getElementById("mainHeader");
    const floatbar = document.getElementById("floatbar");
    const logoBtn = document.getElementById("logoBtn");
    const floatLogoBtn = document.getElementById("floatLogoBtn");

    const catWrap = document.getElementById("catWrap");
    const grid = document.getElementById("grid");
    const searchDrawer = document.getElementById("searchDrawer");
    const searchInput = document.getElementById("searchInput");
    const searchClose = document.getElementById("searchClose");
    const searchResults = document.getElementById("searchResults");

    const cartModal = document.getElementById("cartModal");
    const cartClose = document.getElementById("cartClose");
    const cartList = document.getElementById("cartList");
    const cartEmpty = document.getElementById("cartEmpty");
    const cartTotal = document.getElementById("cartTotal");
    const cartOrderBtn = document.getElementById("cartOrderBtn");

    const productView = document.getElementById("productView");
    const pwrap = document.getElementById("pwrap");
    const productScroll = document.getElementById("productScroll");
    const productBack = document.getElementById("productBack");

    const galleryStage = document.getElementById("galleryStage");
    const galleryDots = document.getElementById("galleryDots");

    const pTitle = document.getElementById("pTitle");
    const pSku = document.getElementById("pSku");
    const pPrice = document.getElementById("pPrice");
    const pOld = document.getElementById("pOld");
    const pSizes = document.getElementById("pSizes");
    const pDescList = document.getElementById("pDescList");

    const relTrack = document.getElementById("relTrack");
    const relScrollbar = document.getElementById("relScrollbar");
    const relThumb = document.getElementById("relThumb");

    const buyNowBtn = document.getElementById("buyNowBtn");
    const addToCartBtn = document.getElementById("addToCartBtn");

    const sizeChartBtn = document.getElementById("sizeChartBtn");
    
    // Элементы нового просмотрщика
    const imageViewer = document.getElementById("imageViewer");
    const viewerImg = document.getElementById("viewerImg");

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const SIZES = ["S","M","L","XL"];

    function fmtRub(n){
      const s = String(Math.round(Number(n) || 0));
      return s.replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " RUB";
    }
    function scrollToTop() { window.scrollTo({ top: 0, behavior: "smooth" }); }
    function byId(id){ return PRODUCTS.find(p => p.id === id) || null; }

    function renderCategories(activeId) {
      catWrap.innerHTML = CATEGORIES.map(c => {
        const active = c.id === activeId ? "active" : "";
        return `<button class="cat ${active}" data-cat="${c.id}" type="button">${c.label}</button>`;
      }).join("");
    }

    function filterProducts(catId) {
      if (catId === "all") return PRODUCTS;
      return PRODUCTS.filter(p => (p.categories || []).includes(catId));
    }

    function renderProducts(catId) {
      const items = filterProducts(catId);
      grid.innerHTML = items.map(p => `
        <article class="card" data-product-id="${p.id}">
          <div class="img" role="button" tabindex="0" aria-label="Открыть ${p.name}" data-open-product="${p.id}">
            <img class="product-photo" src="${p.gallery[0]}" alt="${p.name}">
          </div>
          <div class="name" role="button" tabindex="0" aria-label="Открыть ${p.name}" data-open-product="${p.id}">${p.name}</div>
          <div class="desc">${p.badge}</div>
          <div class="price-row">
            <span>${fmtRub(p.priceRub)}</span>
            <span class="old">${fmtRub(p.oldPriceRub)}</span>
          </div>
          <div class="dolyami" aria-label="${p.dolyami}">
            <img class="dolyami-icon" src="dolyami.png" alt="" aria-hidden="true">
            <span>${p.dolyami}</span>
          </div>
        </article>
      `).join("");
    }

    async function switchCategory(nextId) {
      grid.classList.add("fade-out");
      await sleep(160);
      renderProducts(nextId);
      await sleep(20);
      grid.classList.remove("fade-out");
    }

    function setupFloatingHeader() {
      const io = new IntersectionObserver((entries) => {
        const e = entries[0];
        if (!e) return;
        const show = !e.isIntersecting;
        floatbar.classList.toggle("show", show);
        floatbar.setAttribute("aria-hidden", show ? "false" : "true");
      }, { threshold: 0.1 });
      io.observe(mainHeader);
    }

    async function hideLoaderSoon() {
      const hintTimer = setTimeout(() => loaderHint.classList.add("show"), 2200);
      try { if (document.fonts && document.fonts.ready) await Promise.race([document.fonts.ready, sleep(700)]); } catch(e){}
      await sleep(420);
      clearTimeout(hintTimer);
      loader.classList.add("hide");
      await sleep(300);
      loader.style.display = "none";
    }

    function getHeaderAnchorRect() {
      const isFloat = floatbar.classList.contains("show");
      const anchor = isFloat ? floatbar.querySelector(".floatbar-card") : mainHeader.querySelector(".topbar-card");
      if (!anchor) return null;
      return anchor.getBoundingClientRect();
    }

    function setDrawerTop() {
      const r = getHeaderAnchorRect();
      const top = r ? (r.bottom + 10) : 10;
      searchDrawer.style.top = `${Math.max(8, top)}px`;
    }

    function renderSearchResults(query) {
      const q = (query || "").trim().toLowerCase();
      if (!q) {
        searchResults.innerHTML = `<div class="drawer-empty">начните ввод - появятся товары</div>`;
        return;
      }
      const found = PRODUCTS.filter(p => {
        const hay = `${p.name} ${p.badge} ${fmtRub(p.priceRub)} ${p.id}`.toLowerCase();
        return hay.includes(q);
      }).slice(0, 10);
      if (!found.length) {
        searchResults.innerHTML = `<div class="drawer-empty">ничего не найдено</div>`;
        return;
      }
      searchResults.innerHTML = found.map(p => `
        <div class="result" role="listitem" aria-label="${p.name}" data-open-product="${p.id}">
          <div class="result-img"><img src="${p.gallery[0]}" alt=""></div>
          <div class="result-mid">
            <div class="result-name">${p.name}</div>
            <div class="result-meta">${p.badge}</div>
          </div>
          <div class="result-price">${fmtRub(p.priceRub)}</div>
        </div>
      `).join("");
    }

    function openSearch() {
      if (document.body.classList.contains("product-open")) return;
      setDrawerTop();
      searchDrawer.classList.add("open");
      searchDrawer.setAttribute("aria-hidden", "false");
      setTimeout(() => { try { searchInput.focus({ preventScroll: true }); } catch(e){ searchInput.focus(); } }, 60);
      renderSearchResults(searchInput.value);
    }
    function closeSearch() { searchDrawer.classList.remove("open"); searchDrawer.setAttribute("aria-hidden", "true"); }
    function toggleSearch() { searchDrawer.classList.contains("open") ? closeSearch() : openSearch(); }

    const cart = new Map();
    function cartKey(pid, size){ return `${pid}__${size}`; }

    function addToCart(pid, size){
      const p = byId(pid);
      if (!p) return;
      const k = cartKey(pid, size);
      const cur = cart.get(k);
      if (cur) cart.set(k, { ...cur, qty: cur.qty + 1 });
      else cart.set(k, { pid, size, qty: 1 });
      renderCart();
    }
    function setQty(pid, size, qty){
      const k = cartKey(pid, size);
      if (qty <= 0) cart.delete(k);
      else { const cur = cart.get(k); if (cur) cart.set(k, { ...cur, qty }); }
      renderCart();
    }
    function getCartItems(){ return Array.from(cart.values()); }
    function calcCartTotal(){
      let sum = 0;
      for (const it of getCartItems()){
        const p = byId(it.pid); if (!p) continue;
        sum += (p.priceRub * it.qty);
      }
      return sum;
    }

    function renderCart(){
      const items = getCartItems();
      if (!items.length){
        cartEmpty.style.display = "block"; cartList.innerHTML = ""; cartTotal.textContent = "итого: 0 rub"; return;
      }
      cartEmpty.style.display = "none";
      cartList.innerHTML = items.map(it => {
        const p = byId(it.pid); if (!p) return "";
        const line = `${it.size} • ${fmtRub(p.priceRub)}`;
        return `
          <div class="cart-row" data-cart-pid="${it.pid}" data-cart-size="${it.size}">
            <div class="cart-img"><img src="${p.gallery[0]}" alt=""></div>
            <div class="cart-mid">
              <div class="cart-name">${p.name}</div>
              <div class="cart-meta">${line}</div>
            </div>
            <div class="cart-qty" aria-label="Количество">
              <button class="qty-btn" type="button" data-cart-act="minus" aria-label="Минус">−</button>
              <div class="qty-val">${it.qty}</div>
              <button class="qty-btn" type="button" data-cart-act="plus" aria-label="Плюс">+</button>
            </div>
          </div>
        `;
      }).join("");
      cartTotal.textContent = `итого: ${fmtRub(calcCartTotal()).toLowerCase()}`;
    }

    function openCart() {
      renderCart();
      cartModal.classList.add("show"); cartModal.setAttribute("aria-hidden", "false");
      requestAnimationFrame(() => cartModal.classList.add("visible"));
    }
    function closeCart() {
      cartModal.classList.remove("visible"); cartModal.setAttribute("aria-hidden", "true");
      setTimeout(() => cartModal.classList.remove("show"), 180);
    }
    function buildOrderText(lines, totalRub){
      return `Здравствуйте! Хочу оформить заказ:\n\n${lines.join("\n")}\n\nИтого: ${fmtRub(totalRub)}`;
    }
    function openTelegramOrder(text){ window.open(`https://t.me/furuyumeorders?text=${encodeURIComponent(text)}`, "_blank", "noopener"); }

    function orderFromCart(){
      const items = getCartItems(); if (!items.length) return;
      const lines = items.map(it => {
        const p = byId(it.pid);
        return `${p.name}, ${it.size}, ${fmtRub(p.priceRub)} × ${it.qty} = ${fmtRub(p.priceRub * it.qty)}`;
      });
      openTelegramOrder(buildOrderText(lines, calcCartTotal()));
    }

    let currentProductId = null;
    let currentSize = "M";

    // Отрисовка всех фото в скролл-контейнер и создание точек
    function renderGalleryScroll(p){
      galleryStage.innerHTML = p.gallery.map(src => `<img src="${src}" alt="${p.name}">`).join("");
      galleryDots.innerHTML = p.gallery.map((_, i) => `<div class="dot ${i===0 ? 'active' : ''}"></div>`).join("");
      // Сброс скролла в начало при открытии
      galleryStage.scrollTo({ left: 0, behavior: "instant" });
    }

    // Слушатель для обновления активной точки при скролле галереи
    galleryStage.addEventListener("scroll", () => {
      const width = galleryStage.clientWidth;
      if (width === 0) return;
      const index = Math.round(galleryStage.scrollLeft / width);
      const dots = galleryDots.querySelectorAll('.dot');
      dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
    }, { passive: true });

    function renderSizes(p){
      pSizes.innerHTML = SIZES.map(s => `<button class="sizebtn ${s===currentSize ? "active":""}" type="button" data-size="${s}" aria-label="Размер ${s}">${s}</button>`).join("");
    }
    function renderDesc(p){ pDescList.innerHTML = (p.desc || []).map(x => `<li>${x}</li>`).join(""); }

    function renderRelated(p){
      const pick = PRODUCTS.filter(x => x.id !== p.id).sort(() => Math.random() - 0.5).slice(0, 6);
      relTrack.innerHTML = pick.map(x => `
        <div class="rel-card" role="button" tabindex="0" data-open-product="${x.id}" aria-label="Открыть ${x.name}">
          <div class="rel-img"><img src="${x.gallery[0]}" alt=""></div>
          <div class="rel-name">${x.name}</div>
          <div class="rel-price">${fmtRub(x.priceRub)}</div>
        </div>
      `).join("");
      requestAnimationFrame(updateRelatedScrollbar);
      requestAnimationFrame(() => relTrack.scrollTo({ left: 0, top: 0, behavior: "instant" }));
      requestAnimationFrame(updateRelatedScrollbar);
    }

    function updateSkuLine(){
      const p = byId(currentProductId); if (!p) return;
      pSku.textContent = `Артикул: ${(p.articles && p.articles[currentSize]) ? p.articles[currentSize] : `${p.id}-${currentSize}`}`;
    }

    // Вынесенная функция обновления DOM карточки товара
    function updateProductDOM(p) {
      currentProductId = p.id; 
      currentSize = "M";
      pTitle.textContent = p.name; 
      pPrice.textContent = fmtRub(p.priceRub); 
      pOld.textContent = fmtRub(p.oldPriceRub);
      renderGalleryScroll(p); 
      renderSizes(p); 
      renderDesc(p); 
      renderRelated(p); 
      updateSkuLine();
    }

    // Открытие товара с плавной подгрузкой, если уже находимся в товаре
    async function openProduct(pid){
      const p = byId(pid); if (!p) return;
      closeSearch();
      
      const isAlreadyOpen = document.body.classList.contains("product-open");

      if (isAlreadyOpen) {
        // Плавно затухаем контент
        pwrap.classList.add("fade-out");
        await sleep(220); // Ждем пока исчезнет
        
        // Обновляем данные и скроллим вверх
        updateProductDOM(p);
        productScroll.scrollTo({ top: 0, behavior: "smooth" });
        
        // Плавно показываем
        pwrap.classList.remove("fade-out");
      } else {
        // Обычное открытие
        updateProductDOM(p);
        document.body.classList.add("product-open");
        productView.classList.add("show"); 
        productView.setAttribute("aria-hidden", "false");
        productScroll.scrollTo({ top: 0, behavior: "instant" });
      }
    }

    function closeProduct(){
      productView.classList.remove("show"); productView.setAttribute("aria-hidden", "true");
      document.body.classList.remove("product-open"); currentProductId = null;
    }

    function orderNowCurrent(){
      const p = byId(currentProductId); if (!p) return;
      openTelegramOrder(buildOrderText([`${p.name}, ${currentSize}, ${fmtRub(p.priceRub)}`], p.priceRub));
    }
    
    function addCurrentToCart(){
      const p = byId(currentProductId); if (!p) return;
      addToCart(p.id, currentSize);
      addToCartBtn.style.opacity = "0.75"; setTimeout(() => addToCartBtn.style.opacity = "", 160);
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function updateRelatedScrollbar(){
      if (!relScrollbar || !relThumb || !relTrack) return;
      const sw = relTrack.scrollWidth, cw = relTrack.clientWidth, maxScroll = Math.max(0, sw - cw), barW = relScrollbar.clientWidth;
      if (barW <= 0 || sw <= 0 || cw <= 0 || maxScroll === 0){ relThumb.style.width = "100%"; relThumb.style.transform = "translateX(0px)"; return; }
      const thumbW = clamp(Math.round(barW * (cw / sw)), 34, barW), maxX = Math.max(0, barW - thumbW);
      relThumb.style.width = `${thumbW}px`; relThumb.style.transform = `translateX(${(relTrack.scrollLeft / maxScroll) * maxX}px)`;
    }

    (function setupRelatedScrollbarDrag(){
      if (!relScrollbar || !relThumb || !relTrack) return;
      let dragging = false, startX = 0, startLeft = 0;
      function getThumbMetrics(){
        const barW = relScrollbar.clientWidth, thumbW = relThumb.getBoundingClientRect().width;
        return { barW, thumbW, maxX: Math.max(0, barW - thumbW) };
      }
      function thumbLeftPx(){ const m = relThumb.style.transform.match(/translateX\(([-\d.]+)px\)/); return m ? Number(m[1]) : 0; }
      function setByThumbX(x){
        const { maxX } = getThumbMetrics(), maxScroll = Math.max(0, relTrack.scrollWidth - relTrack.clientWidth);
        if (maxX <= 0 || maxScroll <= 0) return;
        relTrack.scrollLeft = (clamp(x, 0, maxX) / maxX) * maxScroll;
      }
      relScrollbar.addEventListener("pointerdown", (e) => {
        dragging = true; relScrollbar.classList.add("dragging"); relScrollbar.setPointerCapture(e.pointerId);
        startX = e.clientX; startLeft = thumbLeftPx();
        const thumbRect = relThumb.getBoundingClientRect();
        if (!(e.clientX >= thumbRect.left && e.clientX <= thumbRect.right)){
          setByThumbX((e.clientX - relScrollbar.getBoundingClientRect().left) - (getThumbMetrics().thumbW / 2));
          updateRelatedScrollbar(); startLeft = thumbLeftPx(); startX = e.clientX;
        }
      });
      relScrollbar.addEventListener("pointermove", (e) => { if (!dragging) return; setByThumbX(startLeft + (e.clientX - startX)); updateRelatedScrollbar(); });
      function endDrag(){ if (!dragging) return; dragging = false; relScrollbar.classList.remove("dragging"); }
      relScrollbar.addEventListener("pointerup", endDrag); relScrollbar.addEventListener("pointercancel", endDrag);
    })();

    // ✅ Функции нового просмотрщика
    function openImageViewer(src) {
      if (!src) return;
      document.body.classList.add("zoom-open"); // блокируем внешний скролл
      viewerImg.src = src;
      imageViewer.classList.add("show");
      imageViewer.setAttribute("aria-hidden", "false");
      requestAnimationFrame(() => imageViewer.classList.add("visible"));
    }

    function closeImageViewer() {
      imageViewer.classList.remove("visible");
      imageViewer.setAttribute("aria-hidden", "true");
      setTimeout(() => {
        imageViewer.classList.remove("show");
        viewerImg.src = "";
      }, 250);
      document.body.classList.remove("zoom-open");
    }

    imageViewer.addEventListener("click", closeImageViewer);

    (function init(){
      renderCategories("all"); renderProducts("all"); setupFloatingHeader();
      if (logoBtn) logoBtn.addEventListener("click", scrollToTop);
      if (floatLogoBtn) floatLogoBtn.addEventListener("click", scrollToTop);

      catWrap.addEventListener("click", async (e) => {
        const btn = e.target.closest("[data-cat]"); if (!btn) return;
        const nextId = btn.getAttribute("data-cat");
        if (nextId === catWrap.querySelector(".cat.active")?.getAttribute("data-cat")) return;
        catWrap.querySelectorAll(".cat").forEach(x => x.classList.remove("active"));
        btn.classList.add("active"); await switchCategory(nextId);
      });

      document.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-action]"); if (!btn) return;
        const act = btn.getAttribute("data-action");
        if (act === "search") toggleSearch(); if (act === "cart") openCart();
      });

      searchClose.addEventListener("click", closeSearch);
      searchInput.addEventListener("input", (e) => renderSearchResults(e.target.value));

      document.addEventListener("pointerdown", (e) => {
        if (!searchDrawer.classList.contains("open")) return;
        const card = searchDrawer.querySelector(".drawer-card");
        if (e.target.closest('[data-action="search"]')) return;
        if (card && !card.contains(e.target)) closeSearch();
      });

      window.addEventListener("scroll", () => { if (searchDrawer.classList.contains("open")) setDrawerTop(); }, { passive: true });
      window.addEventListener("resize", () => { if (searchDrawer.classList.contains("open")) setDrawerTop(); updateRelatedScrollbar(); });

      document.addEventListener("click", (e) => {
        const open = e.target.closest("[data-open-product]"); if (!open) return;
        const pid = open.getAttribute("data-open-product"); if (pid) openProduct(pid);
      });

      productBack.addEventListener("click", closeProduct);

      document.querySelector(".psizes-wrap").addEventListener("click", (e) => {
        const b = e.target.closest("[data-size]"); if (!b) return;
        const s = b.getAttribute("data-size"); if (!SIZES.includes(s)) return;
        currentSize = s; pSizes.querySelectorAll(".sizebtn").forEach(x => x.classList.toggle("active", x.getAttribute("data-size") === s)); updateSkuLine();
      });

      relTrack.addEventListener("scroll", () => updateRelatedScrollbar(), { passive: true });
      buyNowBtn.addEventListener("click", orderNowCurrent);
      addToCartBtn.addEventListener("click", addCurrentToCart);
      cartClose.addEventListener("click", closeCart);
      cartModal.addEventListener("click", (e) => { if (e.target === cartModal) closeCart(); });
      cartList.addEventListener("click", (e) => {
        const row = e.target.closest(".cart-row"); if (!row) return;
        const pid = row.getAttribute("data-cart-pid"), size = row.getAttribute("data-cart-size"), act = e.target.closest("[data-cart-act]")?.getAttribute("data-cart-act");
        if (!pid || !size || !act) return;
        const cur = cart.get(cartKey(pid, size)); if (!cur) return;
        if (act === "plus") setQty(pid, size, cur.qty + 1); if (act === "minus") setQty(pid, size, cur.qty - 1);
      });
      cartOrderBtn.addEventListener("click", orderFromCart);

      // Клик по фото товара в галерее открывает просмотрщик
      galleryStage.addEventListener("click", (e) => {
        if (!document.body.classList.contains("product-open")) return;
        if (e.target.tagName === 'IMG') {
          openImageViewer(e.target.src);
        }
      });

      // Клик по размерной сетке
      sizeChartBtn.addEventListener("click", () => {
        openImageViewer("sizechart.png");
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeSearch(); closeCart();
          if (imageViewer.classList.contains("show")) closeImageViewer();
          if (document.body.classList.contains("product-open")) closeProduct();
        }
      });

      document.addEventListener('gesturestart', (e) => { if (!document.body.classList.contains("zoom-open")) e.preventDefault(); });
      document.addEventListener('gesturechange', (e) => { if (!document.body.classList.contains("zoom-open")) e.preventDefault(); });
      document.addEventListener('gestureend', (e) => { if (!document.body.classList.contains("zoom-open")) e.preventDefault(); });
      document.addEventListener('wheel', (e) => { if (!document.body.classList.contains("zoom-open") && e.ctrlKey) e.preventDefault(); }, { passive: false });

      let lastTouchEnd = 0;
      document.addEventListener('touchend', function (event) {
        if (document.body.classList.contains("zoom-open")) return;
        const now = Date.now(); if (now - lastTouchEnd <= 250) event.preventDefault(); lastTouchEnd = now;
      }, { passive: false });

      if (document.readyState === "complete" || document.readyState === "interactive") { hideLoaderSoon(); }
      else { document.addEventListener("DOMContentLoaded", hideLoaderSoon, { once: true }); }
    })();
  </script>
</body>
</html>
